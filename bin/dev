#!/usr/bin/env ruby
require 'open3'

class DevTool
  MAIN_HELP_BANNER = <<HEREDOC
Execute various commands within the developer environment

Usage:
  dev [COMMAND] [ARGS...]"
  dev -h|--help

Commands:
  compose            Manage containers (default)
  machine            Manage the virtual machine
  update             Update Dash developer environment

Machine subcommands:
  create-cluster
  destroy

HEREDOC

  TOP_COMMANDS=%w{compose machine update dash}

  def initialize(args)
    if args.empty?
      help
    elsif TOP_COMMANDS.include?(args[0])
      send(args.shift.to_sym, args)
    else
      send(:compose, args)
    end
  end

  def help
    puts MAIN_HELP_BANNER
  end

  def compose(args)
    if args.empty?
      puts `docker-compose --help`
    else
      args.unshift('docker-compose -f docker-compose.yml -f development.yml')
      exec(args.join(' '))
    end
  end

  def machine(args)
    if args.empty?
      puts `docker-machine --help`
    elsif args.first == 'env'
      args.shift
      machine_name = 'default'
      unless args.first.nil?
        machine_name = args.first
      end
      if `docker-machine status #{machine_name}` =~ /Running/
        system("docker-machine env #{machine_name}")
      else
        $stderr.puts "#{machine_name} is not running"
      end
    elsif args.first == 'create'
      puts 'Running `dinghy create` (ignoring args)'
      system('sudo ls > /dev/null')
      system('dinghy create')
      system("#{root_dir}/docker/provision-dinghy.sh")
      exec('dinghy restart')
    elsif args.first == 'create-cluster'
      system('sudo ls > /dev/null')
      exec("#{root_dir}/docker/start-cluster.sh")
    elsif args.first == 'destroy'
      puts 'Running `dinghy destroy` (ignoring args)'
      system('sudo ls > /dev/null')
      exec('dinghy destroy')
    else
      args.unshift('docker-machine')
      exec(args.join(' '))
    end
  end

  def update(args)
    system('cd /usr/local/dev-env && git fetch && git reset --hard origin/master') unless args.first == '--no-pull'
    exec("ansible-playbook #{root_dir}/ansible/mac.yml -i 127.0.0.1, --ask-become-pass")
  end

  def dash(args)
    #system('brew services start dnsmasq')
  end

  def root_dir
    '/usr/local/dev-env'
  end

end

DevTool.new(ARGV) if __FILE__==$0
